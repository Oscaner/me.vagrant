---
- name: Install openconnect
  apt:
    name:
      - openconnect
    state: present
  become: yes

- name: Add vpn alias
  blockinfile:
    path: "~/.bash_profile"
    block: |
      function vpn-{{ item.name }}() {
        ! tmux has-session -t vpn-{{ item.name }} && \
        tmux new-session -s vpn-{{ item.name }} -d " \
          echo '{{ item.password }}' | sudo openconnect \
          --protocol=gp {{ item.server }} \
          --user={{ item['username'] }} --passwd-on-stdin \
          --csd-wrapper={{ item.csd_wrapper }} \
        "
      }
      function vpn-{{ item.name }}-stop() {
        tmux kill-session -t vpn-{{ item.name }}
      }
    insertbefore: EOF
    marker_begin: "BEGIN vpn-{{ item['name'] }}"
    marker_end: "END vpn-{{ item['name'] }}"
    state: present
  become: yes
  become_user: "{{ item['become_user'] }}"
  with_items: "{{ vpn_meta }}"
